"""
Terminal TG 
Version 0.1.5
"""

from telethon import TelegramClient, events
from datetime import datetime

api_id = ''
api_hash = ''

client = TelegramClient('terminal_telegram', api_id, api_hash)

#?????????????? ?????????????????????? ???????????????????? ??????????????????
yv = False

@client.on(events.NewMessage())
async def my_event_handler(event):
    if yv:
        if event.is_private:
           # ???????????????????????? ???????????????? ?? ???????????? ????????
           name = event.chat.first_name
        else:
           # ?????????????????? ???????????????????? ???? ???????????????????? ???????? ?????? ????????????
           if hasattr(event.chat, 'title'):
               name = event.chat.title
           else:
                name = 'Unnamed chat'

        message = event.message.message

        time = datetime.now().strftime("%d/%m/%Y %H:%M:%S") # ???????????????? ???????? ?? ??????????

        # ?????????????? ????????????
        print(f"Name: {name} | Message: {message} | Time: {time}")

#???????????????? ??????????
async def main():
    await client.start()
    print('Client started')
    async with client:
        while True:
            print("\nTerminal TG\nVersion: 0.1.5\nCommands:\nchats\nhistory chat\nsearch cha\nsend name message\nexit")
            user_input = input('Enter command: ')
            print("\n")
            if user_input == 'chats':
                async for dialog in client.iter_dialogs():
                    print(dialog.name)
            elif user_input.startswith('history'):
                chat_id = user_input.split(' ')[1]
                async for message in client.iter_messages(chat_id, limit=10):
                    event = message
                    if event.is_private:
                         # ???????????????????????? ???????????????? ?? ???????????? ????????
                        name = event.chat.first_name
                    else:
                        # ?????????????????? ???????????????????? ???? ???????????????????? ???????? ?????? ????????????
                        if hasattr(event.chat, 'title'):
                           name = event.chat.title
                        else:
                            name = 'Unnamed chat'
                    print(f"Name: {name} | Message: {message.text} | Date: {message.date}")
            elif user_input.startswith('search'):
                chat_s = user_input.split(' ')[1]
                async for dialog in client.iter_dialogs():
                   if chat_s in dialog.name:
                      print("found(name): " + dialog.name)
                   if hasattr(dialog.entity, 'username') and dialog.entity.username is not None and dialog.entity.username != "":
                      if chat_s in dialog.entity.username:
                         print("found(username): " + dialog.entity.username)
            elif user_input.startswith('send'):
                user_to_send = user_input.split(' ')[1]
                message_to_send = user_input.split(' ')[2]
                date = datetime.now().strftime("%d/%m/%Y %H:%M:%S") # ???????????????? ???????? ?? ??????????
                print(f"To: {user_to_send} | Message: {message_to_send} | Date: {date}")
                await client.send_message(user_to_send, message_to_send)
            elif user_input == 'exit':
                break
            else:
                print('Invalid command') 

if __name__ == '__main__':
    try:
        client.loop.run_until_complete(main())
    except KeyboardInterrupt:
        print('Bot has been stopped')
    finally:
        client.disconnect()

